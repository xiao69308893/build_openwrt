#========================================================================================================================
# OpenWrt æ™ºèƒ½ç¼–è¯‘å·¥ä½œæµ - åˆå¹¶ç‰ˆæœ¬
# åŠŸèƒ½: å°†å‚æ•°å‡†å¤‡å’Œæ„å»ºåˆå¹¶åˆ°åŒä¸€ä¸ªä½œä¸šä¸­ï¼Œé¿å…æ–‡ä»¶ä¼ é€’é—®é¢˜
#========================================================================================================================

name: ğŸ¯ OpenWrtæ™ºèƒ½ç¼–è¯‘

on:
  repository_dispatch:
    types: [web_build]
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'æºç åˆ†æ”¯'
        required: true
        default: 'lede-master'
        type: choice
        options:
          - 'lede-master'
          - 'openwrt-main'
          - 'immortalwrt-master'
          - 'Lienol-master'
      target_device:
        description: 'ç›®æ ‡è®¾å¤‡'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - 'x86_64'
          - 'xiaomi_4a_gigabit'
          - 'newifi_d2'
          - 'rpi_4b'
          - 'nanopi_r2s'
      plugins:
        description: 'æ’ä»¶åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: ''
        type: string
      description:
        description: 'ç¼–è¯‘æè¿°'
        required: false
        default: 'æ™ºèƒ½ç¼–è¯‘'
        type: string

env:
  # ç¼–è¯‘ç¯å¢ƒå¸¸é‡
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive

jobs:
  # åˆå¹¶çš„æ„å»ºä»»åŠ¡ - åŒ…å«å‚æ•°å‡†å¤‡å’Œç¼–è¯‘
  build:
    runs-on: ubuntu-24.04
    name: ğŸ”¨ OpenWrtæ™ºèƒ½ç¼–è¯‘
    
    outputs:
      # è¾“å‡ºå…³é”®ä¿¡æ¯ä¾›åç»­ä½¿ç”¨
      build_tag: ${{ steps.prepare.outputs.build_tag }}
      device_name: ${{ steps.prepare.outputs.device_name }}
      firmware_path: ${{ steps.build.outputs.firmware_path }}
      
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ å‡†å¤‡æ„å»ºå‚æ•°
        id: prepare
        run: |
          # è®¾ç½®æ—¶åŒº
          sudo timedatectl set-timezone "$TZ"
          
          # è°ƒç”¨æ„å»ºåè°ƒå™¨è¿›è¡Œå‚æ•°å‡†å¤‡å’ŒéªŒè¯
          chmod +x script/build-coordinator.sh
          
          # æ„å»ºè¾“å…¥å‚æ•°ï¼ˆæ”¯æŒä¸¤ç§è§¦å‘æ–¹å¼ï¼‰
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            # Webç•Œé¢è§¦å‘
            SOURCE_BRANCH="${{ github.event.client_payload.source_branch }}"
            TARGET_DEVICE="${{ github.event.client_payload.target_device }}"
            PLUGINS="${{ github.event.client_payload.plugins }}"
            DESCRIPTION="${{ github.event.client_payload.description }}"
          else
            # æ‰‹åŠ¨è§¦å‘
            SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
            TARGET_DEVICE="${{ github.event.inputs.target_device }}"
            PLUGINS="${{ github.event.inputs.plugins }}"
            DESCRIPTION="${{ github.event.inputs.description }}"
          fi
          
          # è°ƒç”¨æ„å»ºåè°ƒå™¨è¿›è¡Œå‚æ•°å¤„ç†
          CONFIG_FILE=$(./script/build-coordinator.sh prepare \
            --source "$SOURCE_BRANCH" \
            --device "$TARGET_DEVICE" \
            --plugins "$PLUGINS" \
            --description "$DESCRIPTION" \
            --output-env)
          
          # ä¿å­˜é…ç½®æ–‡ä»¶è·¯å¾„åˆ°ç¯å¢ƒå˜é‡
          echo "BUILD_CONFIG_FILE=$CONFIG_FILE" >> $GITHUB_ENV
          
          # è¯»å–å¹¶è¾“å‡ºå…³é”®ä¿¡æ¯
          echo "build_tag=$(jq -r '.build_info.build_tag' $CONFIG_FILE)" >> $GITHUB_OUTPUT
          echo "device_name=$(jq -r '.build_params.target_device' $CONFIG_FILE)" >> $GITHUB_OUTPUT
          echo "source_branch=$(jq -r '.build_params.source_branch' $CONFIG_FILE)" >> $GITHUB_OUTPUT

      - name: ğŸš€ æ‰§è¡Œæ™ºèƒ½ç¼–è¯‘
        id: build
        run: |
          # ç›´æ¥è°ƒç”¨æ„å»ºåè°ƒå™¨æ‰§è¡Œç¼–è¯‘ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„é…ç½®æ–‡ä»¶
          ./script/build-coordinator.sh build \
            --config-file "$BUILD_CONFIG_FILE" \
            --auto-fix \
            --verbose
          
          # è¾“å‡ºå›ºä»¶è·¯å¾„ï¼ˆå¦‚æœæ„å»ºæˆåŠŸï¼‰
          if [ -d "openwrt/bin/targets" ]; then
            FIRMWARE_PATH=$(find openwrt/bin/targets -name "*.img" -o -name "*.bin" | head -1)
            echo "firmware_path=$FIRMWARE_PATH" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©
        id: organize
        if: steps.build.conclusion == 'success'
        run: |
          # è°ƒç”¨æ„å»ºåè°ƒå™¨è¿›è¡Œäº§ç‰©æ•´ç†
          ./script/build-coordinator.sh organize \
            --config-file "$BUILD_CONFIG_FILE"

      - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶
        if: steps.build.conclusion == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-Firmware-${{ steps.prepare.outputs.build_tag }}
          path: |
            openwrt/bin/targets/*/*/*.img
            openwrt/bin/targets/*/*/*.bin
            openwrt/bin/targets/*/*/*.vmdk
            openwrt/bin/targets/*/*/sha256sums
          retention-days: 7

      - name: ğŸ“‹ ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        if: always()
        run: |
          # è°ƒç”¨æ„å»ºåè°ƒå™¨ç”Ÿæˆé€šçŸ¥
          ./script/build-coordinator.sh notify \
            --config-file "$BUILD_CONFIG_FILE" \
            --status "${{ steps.build.conclusion }}"

  # å¯é€‰ï¼šå‘å¸ƒåˆ°Releaseï¼ˆä»…åœ¨æˆåŠŸæ—¶ï¼‰
  release:
    runs-on: ubuntu-24.04
    needs: build
    if: needs.build.result == 'success'
    name: ğŸ“¦ å‘å¸ƒå›ºä»¶
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ ä¸‹è½½å›ºä»¶
        uses: actions/download-artifact@v4
        with:
          name: OpenWrt-Firmware-${{ needs.build.outputs.build_tag }}
          path: firmware/
          
      - name: ğŸ·ï¸ åˆ›å»ºRelease
        uses: ncipollo/release-action@v1
        with:
          name: OpenWrt-${{ needs.build.outputs.build_tag }}
          tag: ${{ needs.build.outputs.build_tag }}
          body: |
            ## ğŸ“¦ OpenWrtå›ºä»¶å‘å¸ƒ
            
            **è®¾å¤‡å‹å·**: ${{ needs.build.outputs.device_name }}
            **ç¼–è¯‘æ—¶é—´**: ${{ github.run_started_at }}
            **æºç åˆ†æ”¯**: ${{ github.event.inputs.source_branch || github.event.client_payload.source_branch }}
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            - é€‰æ‹©å¯¹åº”è®¾å¤‡çš„å›ºä»¶æ–‡ä»¶
            - æŸ¥çœ‹sha256sumséªŒè¯æ–‡ä»¶å®Œæ•´æ€§
            - æŒ‰ç…§è®¾å¤‡åˆ·æœºæ•™ç¨‹è¿›è¡Œå®‰è£…
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            - [ç¼–è¯‘æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [æºç ä»“åº“](https://github.com/${{ github.repository }})

          draft: false
          prerelease: false