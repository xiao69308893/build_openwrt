#========================================================================================================================
# OpenWrt æ™ºèƒ½ç¼–è¯‘å·¥ä½œæµ - é‡æ„ç®€åŒ–ç‰ˆ
# åŠŸèƒ½: ä¸“æ³¨äºç¼–è¯‘è°ƒåº¦å’ŒGitHub Actionsç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå…·ä½“é€»è¾‘ç”±è„šæœ¬å¤„ç†
#========================================================================================================================

name: ğŸ¯ OpenWrtæ™ºèƒ½ç¼–è¯‘

on:
  repository_dispatch:
    types: [web_build]
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'æºç åˆ†æ”¯'
        required: true
        default: 'lede-master'
        type: choice
        options:
          - 'lede-master'
          - 'openwrt-main'
          - 'immortalwrt-master'
          - 'Lienol-master'
      target_device:
        description: 'ç›®æ ‡è®¾å¤‡'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - 'x86_64'
          - 'xiaomi_4a_gigabit'
          - 'newifi_d2'
          - 'rpi_4b'
          - 'nanopi_r2s'
      plugins:
        description: 'æ’ä»¶åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: ''
        type: string
      description:
        description: 'ç¼–è¯‘æè¿°'
        required: false
        default: 'æ™ºèƒ½ç¼–è¯‘'
        type: string

env:
  # ç¼–è¯‘ç¯å¢ƒå¸¸é‡
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive

jobs:
  # æ„å»ºå‚æ•°å‡†å¤‡å’ŒéªŒè¯
  prepare:
    runs-on: ubuntu-24.04
    name: ğŸ“‹ å‡†å¤‡æ„å»ºå‚æ•°
    outputs:
      # æ ‡å‡†åŒ–åçš„æ„å»ºå‚æ•°
      build_config: ${{ steps.prepare.outputs.build_config }}
      source_branch: ${{ steps.prepare.outputs.source_branch }}
      target_device: ${{ steps.prepare.outputs.target_device }}
      plugins_list: ${{ steps.prepare.outputs.plugins_list }}
      build_tag: ${{ steps.prepare.outputs.build_tag }}
      device_name: ${{ steps.prepare.outputs.device_name }}
      
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ å‡†å¤‡æ„å»ºå‚æ•°
        id: prepare
        run: |
          # è°ƒç”¨æ„å»ºåè°ƒå™¨è¿›è¡Œå‚æ•°å‡†å¤‡å’ŒéªŒè¯
          chmod +x script/build-coordinator.sh
          
          # æ„å»ºè¾“å…¥å‚æ•°ï¼ˆæ”¯æŒä¸¤ç§è§¦å‘æ–¹å¼ï¼‰
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            # Webç•Œé¢è§¦å‘
            SOURCE_BRANCH="${{ github.event.client_payload.source_branch }}"
            TARGET_DEVICE="${{ github.event.client_payload.target_device }}"
            PLUGINS="${{ github.event.client_payload.plugins }}"
            DESCRIPTION="${{ github.event.client_payload.description }}"
          else
            # æ‰‹åŠ¨è§¦å‘
            SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
            TARGET_DEVICE="${{ github.event.inputs.target_device }}"
            PLUGINS="${{ github.event.inputs.plugins }}"
            DESCRIPTION="${{ github.event.inputs.description }}"
          fi
          
          # è°ƒç”¨æ„å»ºåè°ƒå™¨è¿›è¡Œå‚æ•°å¤„ç†
          ./script/build-coordinator.sh prepare \
            --source "$SOURCE_BRANCH" \
            --device "$TARGET_DEVICE" \
            --plugins "$PLUGINS" \
            --description "$DESCRIPTION" \
            --output-env

  # ä¸»ç¼–è¯‘ä»»åŠ¡ - ç®€åŒ–ä¸ºçº¯è°ƒåº¦
  build:
    runs-on: ubuntu-24.04
    needs: prepare
    name: ğŸ”¨ OpenWrtç¼–è¯‘
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸš€ æ‰§è¡Œæ™ºèƒ½ç¼–è¯‘
        id: build
        run: |
          # è®¾ç½®æ—¶åŒº
          sudo timedatectl set-timezone "$TZ"
          
          # è°ƒç”¨æ„å»ºåè°ƒå™¨æ‰§è¡Œå®Œæ•´ç¼–è¯‘æµç¨‹
          chmod +x script/build-coordinator.sh
          
          ./script/build-coordinator.sh build \
            --config-file "${{ needs.prepare.outputs.build_config }}" \
            --auto-fix \
            --verbose

      - name: ğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©
        id: organize
        if: steps.build.outputs.status == 'success'
        run: |
          # è°ƒç”¨æ„å»ºåè°ƒå™¨è¿›è¡Œäº§ç‰©æ•´ç†
          ./script/build-coordinator.sh organize \
            --config-file "${{ needs.prepare.outputs.build_config }}" \
            --device "${{ needs.prepare.outputs.target_device }}"

      - name: â¬†ï¸ ä¸Šä¼ å›ºä»¶åˆ° Artifacts
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success'
        with:
          name: ${{ needs.prepare.outputs.build_tag }}
          path: ${{ steps.organize.outputs.firmware_path }}
          retention-days: 7

      - name: ğŸ“¢ å‘å¸ƒå›ºä»¶åˆ° Releases
        uses: softprops/action-gh-release@v2
        if: steps.organize.outputs.release_tag != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.organize.outputs.release_tag }}
          name: ${{ steps.organize.outputs.release_name }}
          body_path: ${{ steps.organize.outputs.firmware_path }}/firmware_info.txt
          files: |
            ${{ steps.organize.outputs.firmware_path }}/OpenWrt_*
            ${{ steps.organize.outputs.firmware_path }}/sha256sums.txt
          draft: false
          prerelease: false

  # æ„å»ºå®Œæˆé€šçŸ¥ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
  notify:
    runs-on: ubuntu-24.04
    needs: [prepare, build]
    if: always()
    name: ğŸ“± æ„å»ºé€šçŸ¥
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“Š ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        run: |
          # è°ƒç”¨æ„å»ºåè°ƒå™¨ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
          chmod +x script/build-coordinator.sh
          
          BUILD_STATUS="${{ needs.build.result }}"
          
          ./script/build-coordinator.sh notify \
            --config-file "${{ needs.prepare.outputs.build_config }}" \
            --build-status "$BUILD_STATUS" \
            --run-id "${{ github.run_id }}" \
            --repository "${{ github.repository }}"

      - name: ğŸ§¹ æ¸…ç†æ—§è®°å½•
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 7
          keep_minimum_runs: 5
          token: ${{ secrets.GITHUB_TOKEN }}