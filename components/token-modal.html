<!-- 
  Tokené…ç½®æ¨¡æ€æ¡†ç»„ä»¶
  æ–‡ä»¶å: token-modal.html
  ç”¨é€”: å®‰å…¨çš„GitHub Tokené…ç½®ç•Œé¢
-->

<!-- Tokené…ç½®æ¨¡æ€æ¡† -->
<div id="tokenModal" class="token-modal">
    <div class="token-dialog">
        <div class="token-header">
            <h2>ğŸ” GitHub Token é…ç½®</h2>
            <p>ä¸ºäº†æ­£å¸¸ä½¿ç”¨ç¼–è¯‘åŠŸèƒ½ï¼Œéœ€è¦é…ç½®GitHub Personal Access Token</p>
        </div>

        <!-- TokençŠ¶æ€æ˜¾ç¤º -->
        <div id="tokenStatus" class="token-status" style="display: none;">
            <span id="statusIcon">âœ…</span>
            <span id="statusText">Tokené…ç½®æˆåŠŸ</span>
        </div>

        <!-- å®‰å…¨æç¤º -->
        <div class="token-security-tips">
            <div class="security-title">ğŸ›¡ï¸ å®‰å…¨æç¤º</div>
            <div class="security-tips">
                â€¢ Tokenå…·æœ‰è®¿é—®GitHubçš„æƒé™ï¼Œè¯·å¦¥å–„ä¿ç®¡<br>
                â€¢ å»ºè®®åˆ›å»ºæƒé™æœ€å°çš„Tokenï¼ˆåªé€‰æ‹©å¿…è¦æƒé™ï¼‰<br>
                â€¢ ä¸è¦åœ¨å…¬å…±åœºæ‰€æˆ–ä»–äººè®¾å¤‡ä¸Šä¿å­˜Token<br>
                â€¢ å®šæœŸæ›´æ¢Tokenä»¥æé«˜å®‰å…¨æ€§
            </div>
        </div>

        <!-- é…ç½®æ–¹æ³•é€‰æ‹© -->
        <div class="token-methods">
            <div class="token-method active" data-method="input">
                <div class="method-icon">âŒ¨ï¸</div>
                <div class="method-title">æ‰‹åŠ¨è¾“å…¥</div>
                <div class="method-desc">ç›´æ¥è¾“å…¥GitHub Token</div>
            </div>
            <div class="token-method" data-method="guide">
                <div class="method-icon">ğŸ“‹</div>
                <div class="method-title">åˆ›å»ºæŒ‡å—</div>
                <div class="method-desc">æŸ¥çœ‹Tokenåˆ›å»ºæ­¥éª¤</div>
            </div>
        </div>

        <!-- æ‰‹åŠ¨è¾“å…¥åŒºåŸŸ -->
        <div id="inputSection" class="token-input-section show">
            <div class="input-group">
                <label for="tokenInput" class="input-label">GitHub Personal Access Token</label>
                <input type="password" id="tokenInput" class="input-field"
                    placeholder="è¯·è¾“å…¥ä»¥ ghp_ æˆ– github_pat_ å¼€å¤´çš„Token">
                <div class="input-help">
                    Tokenæ ¼å¼: ghp_xxxxxxxxxxxx æˆ– github_pat_xxxxxxxxxxxx
                </div>
            </div>

            <div class="input-group">
                <label>
                    <input type="checkbox" id="saveToken">
                    ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ï¼ˆä»…åœ¨ä¸ªäººè®¾å¤‡ä¸Šå‹¾é€‰ï¼‰
                </label>
            </div>
        </div>

        <!-- åˆ›å»ºæŒ‡å—åŒºåŸŸ -->
        <div id="guideSection" class="token-input-section">
            <div class="github-steps">
                <h4>ğŸ“ GitHub Token åˆ›å»ºæ­¥éª¤</h4>
                <ol>
                    <li>ç™»å½•GitHubï¼Œç‚¹å‡»å³ä¸Šè§’å¤´åƒ â†’ <code>Settings</code></li>
                    <li>åœ¨å·¦ä¾§èœå•ä¸­é€‰æ‹© <code>Developer settings</code></li>
                    <li>é€‰æ‹© <code>Personal access tokens</code> â†’ <code>Tokens (classic)</code></li>
                    <li>ç‚¹å‡» <code>Generate new token</code> â†’ <code>Generate new token (classic)</code></li>
                    <li>å¡«å†™Tokenæè¿°ï¼Œå¦‚ "OpenWrt Builder"</li>
                    <li>é€‰æ‹©è¿‡æœŸæ—¶é—´ï¼ˆå»ºè®®30-90å¤©ï¼‰</li>
                    <li>é€‰æ‹©æƒé™èŒƒå›´ï¼š
                        <ul style="margin-top: 8px;">
                            <li><code>repo</code> - ä»“åº“è®¿é—®æƒé™</li>
                            <li><code>workflow</code> - GitHub Actionsæƒé™</li>
                            <li><code>write:packages</code> - åŒ…å‘å¸ƒæƒé™ï¼ˆå¯é€‰ï¼‰</li>
                        </ul>
                    </li>
                    <li>ç‚¹å‡» <code>Generate token</code> ç”ŸæˆToken</li>
                    <li>âš ï¸ <strong>ç«‹å³å¤åˆ¶Token</strong>ï¼ˆç¦»å¼€é¡µé¢åæ— æ³•å†æ¬¡æŸ¥çœ‹ï¼‰</li>
                </ol>
            </div>

            <div class="input-group">
                <label for="guideTokenInput" class="input-label">å°†åˆ›å»ºçš„Tokenç²˜è´´åˆ°è¿™é‡Œ</label>
                <input type="password" id="guideTokenInput" class="input-field"
                    placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="token-actions">
            <button class="btn btn-secondary" onclick="window.tokenModal.close()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="window.tokenModal.save()">ä¿å­˜é…ç½®</button>
            <button class="btn btn-secondary" onclick="window.tokenModal.test()" style="display: none;"
                id="testBtn">æµ‹è¯•è¿æ¥</button>
        </div>
    </div>
</div>

<!-- Tokené…ç½®æ ·å¼ -->
<style>
    .token-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .token-modal.show {
        display: flex;
    }

    .token-dialog {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .token-header {
        text-align: center;
        margin-bottom: 25px;
    }

    .token-header h2 {
        color: #2c3e50;
        margin-bottom: 10px;
    }

    .token-header p {
        color: #666;
        line-height: 1.6;
    }

    .token-methods {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
    }

    .token-method {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .token-method:hover {
        border-color: #667eea;
        background: #f8f9ff;
    }

    .token-method.active {
        border-color: #667eea;
        background: linear-gradient(135deg, #667eea10, #764ba210);
    }

    .method-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }

    .method-title {
        font-weight: bold;
        margin-bottom: 8px;
        color: #2c3e50;
    }

    .method-desc {
        font-size: 0.9rem;
        color: #666;
    }

    .token-input-section {
        display: none;
        margin-top: 20px;
    }

    .token-input-section.show {
        display: block;
    }

    .input-group {
        margin-bottom: 20px;
    }

    .input-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
    }

    .input-field {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        font-family: 'Courier New', monospace;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
    }

    .input-field:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .input-help {
        font-size: 0.85rem;
        color: #666;
        margin-top: 5px;
    }

    .token-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 25px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
    }

    .btn-secondary:hover {
        background: #cbd5e0;
    }

    .token-status {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .token-status.valid {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .token-status.invalid {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .token-security-tips {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-left: 4px solid #fdcb6e;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .security-title {
        font-weight: bold;
        color: #856404;
        margin-bottom: 8px;
    }

    .security-tips {
        font-size: 0.9rem;
        color: #856404;
        line-height: 1.5;
    }

    .github-steps {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .github-steps h4 {
        margin-bottom: 15px;
        color: #2c3e50;
    }

    .github-steps ol {
        margin-left: 20px;
    }

    .github-steps li {
        margin-bottom: 8px;
        line-height: 1.5;
    }

    .github-steps code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
    }

    @media (max-width: 768px) {
        .token-methods {
            grid-template-columns: 1fr;
        }

        .token-actions {
            flex-direction: column;
        }

        .token-dialog {
            padding: 20px;
            margin: 20px;
        }
    }
</style>

<!-- Tokené…ç½®è„šæœ¬ -->
<script>
    // Tokenæ¨¡æ€æ¡†ç®¡ç†å™¨
    window.tokenModal = {
        currentMethod: 'input',

        // åˆå§‹åŒ–
        init() {
            this.bindEvents();
            this.checkExistingToken();
        },

        // ç»‘å®šäº‹ä»¶
        bindEvents() {
            // æ–¹æ³•é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.token-method').forEach(method => {
                method.addEventListener('click', () => {
                    this.selectMethod(method.dataset.method);
                });
            });

            // è¾“å…¥æ¡†éªŒè¯äº‹ä»¶
            document.getElementById('tokenInput').addEventListener('input', () => this.validateToken());
            document.getElementById('guideTokenInput').addEventListener('input', () => this.validateToken());

            // å…³é—­äº‹ä»¶
            document.getElementById('tokenModal').addEventListener('click', (e) => {
                if (e.target.id === 'tokenModal') {
                    this.close();
                }
            });
        },

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        show() {
            document.getElementById('tokenModal').classList.add('show');
            this.selectMethod('input');
        },

        // å…³é—­æ¨¡æ€æ¡†
        close() {
            document.getElementById('tokenModal').classList.remove('show');
        },

        // é€‰æ‹©é…ç½®æ–¹æ³•
        selectMethod(method) {
            this.currentMethod = method;

            // æ›´æ–°æ–¹æ³•é€‰æ‹©çŠ¶æ€
            document.querySelectorAll('.token-method').forEach(m => {
                m.classList.remove('active');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('active');

            // æ˜¾ç¤ºå¯¹åº”çš„è¾“å…¥åŒºåŸŸ
            document.querySelectorAll('.token-input-section').forEach(section => {
                section.classList.remove('show');
            });

            if (method === 'input') {
                document.getElementById('inputSection').classList.add('show');
            } else if (method === 'guide') {
                document.getElementById('guideSection').classList.add('show');
            }
        },

        // éªŒè¯Token
        validateToken() {
            const input = this.currentMethod === 'input' ?
                document.getElementById('tokenInput') :
                document.getElementById('guideTokenInput');

            const token = input.value.trim();
            const isValid = token.startsWith('ghp_') || token.startsWith('github_pat_');

            if (token && !isValid) {
                input.style.borderColor = '#e74c3c';
                this.showStatus(false, 'Tokenæ ¼å¼ä¸æ­£ç¡®');
            } else if (isValid) {
                input.style.borderColor = '#27ae60';
                this.showStatus(true, 'Tokenæ ¼å¼æ­£ç¡®');
                document.getElementById('testBtn').style.display = 'inline-block';
            } else {
                input.style.borderColor = '#e0e0e0';
                this.hideStatus();
                document.getElementById('testBtn').style.display = 'none';
            }
        },

        // æ˜¾ç¤ºçŠ¶æ€
        showStatus(isValid, message) {
            const statusDiv = document.getElementById('tokenStatus');
            const iconSpan = document.getElementById('statusIcon');
            const textSpan = document.getElementById('statusText');

            statusDiv.style.display = 'flex';
            statusDiv.className = `token-status ${isValid ? 'valid' : 'invalid'}`;
            iconSpan.textContent = isValid ? 'âœ…' : 'âŒ';
            textSpan.textContent = message;
        },

        // éšè—çŠ¶æ€
        hideStatus() {
            document.getElementById('tokenStatus').style.display = 'none';
        },

        // æ£€æŸ¥ç°æœ‰Token
        checkExistingToken() {
            const existingToken = this.getStoredToken();
            if (existingToken) {
                const maskedToken = existingToken.substring(0, 8) + '*'.repeat(12) + existingToken.substring(existingToken.length - 4);
                document.getElementById('tokenInput').placeholder = `å½“å‰Token: ${maskedToken}`;
                this.showStatus(true, 'å·²é…ç½®Token');
            }
        },

        // è·å–å­˜å‚¨çš„Token
        getStoredToken() {
            return localStorage.getItem('github_token') || window.GITHUB_TOKEN || null;
        },

        // æµ‹è¯•Tokenè¿æ¥
        async test() {
            const input = this.currentMethod === 'input' ?
                document.getElementById('tokenInput') :
                document.getElementById('guideTokenInput');

            const token = input.value.trim();
            if (!token) return;

            this.showStatus(true, 'æ­£åœ¨æµ‹è¯•è¿æ¥...');

            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    this.showStatus(true, `è¿æ¥æˆåŠŸï¼ç”¨æˆ·: ${userData.login}`);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                this.showStatus(false, `è¿æ¥å¤±è´¥: ${error.message}`);
            }
        },

        // ä¿å­˜Token
        save() {
            const input = this.currentMethod === 'input' ?
                document.getElementById('tokenInput') :
                document.getElementById('guideTokenInput');

            const token = input.value.trim();

            if (!token) {
                alert('è¯·è¾“å…¥GitHub Token');
                return;
            }

            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                alert('Tokenæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥è¾“å…¥');
                return;
            }

            // ä¿å­˜Token
            const shouldSave = this.currentMethod === 'input' ?
                document.getElementById('saveToken').checked : true;

            if (shouldSave) {
                localStorage.setItem('github_token', token);
            }

            // è®¾ç½®åˆ°å…¨å±€å˜é‡
            window.GITHUB_TOKEN = token;

            this.showStatus(true, 'Tokené…ç½®æˆåŠŸï¼');

            // é€šçŸ¥å…¶ä»–ç»„ä»¶Tokenå·²é…ç½®
            if (typeof onTokenConfigured === 'function') {
                onTokenConfigured(token);
            }

            // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
            window.dispatchEvent(new CustomEvent('tokenConfigured', { detail: { token } }));

            // å»¶è¿Ÿå…³é—­æ¨¡æ€æ¡†
            setTimeout(() => {
                this.close();
            }, 1500);
        },

        // æ¸…é™¤Token
        clear() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤Tokené…ç½®å—ï¼Ÿ')) {
                localStorage.removeItem('github_token');
                delete window.GITHUB_TOKEN;

                document.getElementById('tokenInput').value = '';
                document.getElementById('guideTokenInput').value = '';
                document.getElementById('tokenInput').placeholder = 'è¯·è¾“å…¥ä»¥ ghp_ æˆ– github_pat_ å¼€å¤´çš„Token';

                this.hideStatus();
                alert('Tokené…ç½®å·²æ¸…é™¤');
            }
        }
    };

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
        window.tokenModal.init();
    });
</script>